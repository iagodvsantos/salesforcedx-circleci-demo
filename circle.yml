machine:
  timezone: America/New_York
  environment:
    DX_CLI_URL: https://developer.salesforce.com/media/salesforce-cli/sfdx-linux-amd64.tar.xz
    SFDX_AUTOUPDATE_DISABLE: true
    SFDX_USE_GENERIC_UNIX_KEYCHAIN: true
    SFDX_DOMAIN_RETRY: 300

dependencies:
  override:
    - wget -qO- $DX_CLI_URL | tar xJf -
    - ./sfdx/install
    - mkdir tmp
    - echo $SERVER_KEY_HEX | xxd -r -ps >> tmp/server.key
    - openssl rsa -in tmp/server.key -check -noout
    - sfdx update
    - sfdx force:auth:jwt:grant --clientid $CONSUMER_KEY --jwtkeyfile tmp/server.key --username $SFDC_USER --setdefaultdevhubusername -a HubOrg

test:
  override:
    - sfdx force:org:list
    - sfdx force:source:push -u HubOrg
    - sfdx force:apex:test:run -u HubOrg -c -r human
